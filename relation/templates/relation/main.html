<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Graph</title>
    <style>
        /* 기본 스타일 설정 */
        body {
            background-color: rgb(0, 0, 0);
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden; /* 상하좌우 스크롤바 비활성화 */
        }

        /* 헤더 스타일 설정 */
        header {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1100; /* 메뉴바가 사이드바보다 위에 위치 */
            position: relative; /* 메뉴바를 최상단에 고정 */
        }

        #network {
            width: 100vw; /* 뷰포트 너비에 맞춤 */
            height: calc(100vh - 50px); /* 뷰포트 높이에서 헤더 높이를 뺀 값 */
            border: 1px solid rgb(61, 57, 57);
            margin: 0 auto;
            display: block;
        }

        /* 새로고침 아이콘 스타일 */
        #refresh-icon {
            cursor: pointer;
            font-size: 24px;
        }

        /* 메뉴 스타일 설정 */
        #menu {
            position: relative;
        }

        #menu button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        #menu button img {
            width: 35px;
            height: 35px;
        }

        #menu button:hover img {
            opacity: 0.7;
        }

        #menu-items {
            position: absolute;
            right: 0;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 2px solid #ccc;
            margin-top: 10px;
            padding: 10px;
            display: none;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            z-index: 1000; /* 다른 요소 위에 표시되도록 설정 */
        }

        #menu-items a, #menu-items button {
            text-decoration: none;
            color: black;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            text-align: right;
            width: 100%; /* 버튼이 부모 요소의 너비를 채우도록 설정 */
            padding: 10px;
            background-color: transparent; /* 배경색 투명 */
            border-radius: 4px; /* 버튼에 약간의 테두리 둥글기를 추가 */
            display: block; /* 버튼이 블록 요소로 표시되도록 설정 */
        }

        /* 노드 팝업 스타일 */
        #node-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background-color: #333;
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            display: none;
        }

        #node-popup h2 {
            margin-top: 0;
            font-size: 24px;
        }

        #node-popup p {
            margin: 10px 0 0 0;
            font-size: 16px;
        }

        /* 사이드 페이지 스타일 */
        #side-panel {
            position: fixed;
            top: 0;
            right: -100%; /* 처음에는 화면 밖에 위치 */
            width: 25%;
            height: 100%;
            background-color: #222;
            color: white;
            transition: right 0.7s ease; /* 슬라이드 효과 */
            z-index: 1000;
            margin-top: 40px;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
        }

        /* 사이드 패널 내용 */
        #side-panel h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        #side-panel p {
            font-size: 16px;
            margin-bottom: 20px;
        }

        #save-button {
            position: absolute;
            bottom: 90px;
            right: 20px;
            padding: 10px 20px;
            background-color: #4CAF50; /* 버튼 배경색 */
            color: white;
            border: none;
            border-radius: 10px; /* 모서리를 둥글게 */
            font-size: 16px;
            cursor: pointer;
        }
        
        #save-button:hover {
            background-color: #45a049; /* 호버 시 배경색 */
        }


        /* 검색바 컨테이너 스타일 */
        .search-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 25%;
        }

        #search-bar {
            width: 100%;
            padding: 10px;
            border: 3px solid #00000098;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<header>
    <!-- 새로고침 아이콘 -->
    <div id="refresh-icon" onclick="refreshPage()">&#x21bb;</div>
    <!-- 메뉴 버튼과 메뉴 항목 -->
    <div id="menu">
    <button onclick="toggleMenu()">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR6hlW3yb43CG_IoTpC4KEJFqUfumXpmhppag&s" alt="Menu Icon" style="width: 35px; height: 35px;">
    </button>
    <div id="menu-items" class="hidden">
        <a href="{% url 'mypage' %}" id="mypage">마이페이지</a>
        <form id="logout-form" action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" id="logout">로그아웃</button>
        </form>
    </div>
</div>
</header>
<main>
    <div class="content">
        <!-- 네트워크 그래프를 표시할 div -->
        <div id="network"></div>
        <div id="side-panel">
            <h2 id="panel-title">Node Title</h2>
            <p id="panel-description">Node description will be shown here.</p>
            <button id="save-button">저장</button>
        </div>
    </div>
    <div class="search-container" style="position: absolute; bottom: 2%; left: 50%; transform: translateX(-50%); width: 25%;">
        <ul id="suggestions" style="display: none; background-color: white; border: 1px solid #ccc; list-style: none; padding: 0; position: absolute; bottom: 110%; width: 100%;"></ul>
        <input type="text" id="search-bar" placeholder="Search..." style="width: 100%; padding: 10px; border: 3px solid #00000098; border-radius: 5px;">
    </div>
    <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
<script>
    var nodes;  // 전역 변수로 선언하여 검색에서도 접근 가능하게 함
    var network;  // 전역 변수로 선언하여 검색에서도 접근 가능하게 함

    // 메뉴 버튼 클릭 시 메뉴를 토글하는 함수
    function toggleMenu() {
        const menuItems = document.getElementById('menu-items');
        menuItems.style.display = menuItems.style.display === 'flex' ? 'none' : 'flex';
    }

    // 새로고침 아이콘 클릭 시 페이지를 새로고침하는 함수
    function refreshPage() {
        location.reload();
    }

    // 네트워크 그래프 생성
    function showNetwork() {
        // 서버에서 노드 및 엣지 데이터를 가져옴
        fetch('/get_network_data/')
            .then(response => response.json())
            .then(data => {
                var container = document.getElementById('network');
                nodes = new vis.DataSet(data.nodes.map(node => ({
                    id: node.id,
                    label: node.label,
                    searchkeyword: node.label.toLowerCase(),  // 검색을 위해 사용
                    x: node.x * 1000,  // 좌표 값이 작을 수 있으니 적절히 스케일 조정
                    y: node.y * 1000,  // 좌표 값 스케일 조정
                    fixed: true  // 노드의 위치를 고정
                })));

                var edges = new vis.DataSet(data.edges);
                
                var options = {
                    physics: {
                        enabled: false  // 물리 엔진을 비활성화하여 고정된 좌표 사용
                    },
                    interaction: {
                        dragNodes: true,  // 노드를 드래그할 수 있도록 설정
                        hover: true,      // 노드에 마우스 올리면 강조
                        selectable: true, // 노드를 선택할 수 있음
                    },
                    edges: {
                        color: { 
                            color: '#FFFFFF',
                            highlight: '#87CEFA',
                            hover: '#FFFFFF'
                        },
                        smooth: {
                            type: 'dynamic',  // 엣지를 부드럽게 보여줌
                        }
                    },
                    nodes: {
                        shape: 'dot',
                        size: 8,
                        color: {
                            border: '#FFFFFF',
                            background: '#000000',
                            highlight: {
                                border: '#2B7CE9',
                                background: '#D2E5FF'
                            },
                            hover: {
                                border: '#2B7CE9',
                                background: '#D2E5FF'
                            }
                        },
                        font: {
                            color: '#FFFFFF',
                            size: 7,
                            face: 'Arial',
                            align: 'center',
                            strokeWidth: 3,
                            strokeColor: '#000000'
                        },
                        scaling: {
                            min: 10,
                            max: 30
                        },
                        borderWidth: 1
                    }
                };

                network = new vis.Network(container, { nodes: nodes, edges: edges }, options);

                // 노드 클릭 시 해당 노드 정보를 사이드 패널에 표시
                network.on("click", function (params) {
                    if (params.nodes.length > 0) {
                        var nodeId = params.nodes[0];
                        fetch(`/get_node_data/${nodeId}/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.error) {
                                    console.error(data.error);
                                } else {
                                    showSidePanel(data);
                                    network.focus(nodeId, {
                                        scale: 2.0,
                                        animation: {
                                            duration: 1000,
                                            easingFunction: "easeInOutQuad"
                                        }
                                    });
                                }
                            });
                    } else {
                        hideSidePanel();
                        network.fit({
                            animation: {
                                duration: 1000,
                                easingFunction: "easeInOutQuad"
                            }
                        });
                    }
                });
            });
    }

    // 페이지 로드 시 네트워크 그래프 생성 함수 호출
    window.onload = function () {
        showNetwork();
    };

    // 사이드 패널을 보여주는 함수
    function showSidePanel(nodeData) {
        var sidePanel = document.getElementById('side-panel');
        document.getElementById('panel-title').textContent = nodeData.label;
        document.getElementById('panel-description').textContent = nodeData.mean; // DB에서 가져온 'mean' 값 표시

        sidePanel.style.right = '0'; // 슬라이드 애니메이션을 위한 위치 변경
    }


    // 사이드 패널을 숨기는 함수
    function hideSidePanel() {
        var sidePanel = document.getElementById('side-panel');
        sidePanel.style.right = '-100%'; // 다시 오른쪽으로 슬라이드
    }

    // 검색창에 입력이 있을 때 유사한 노드 목록을 표시하는 이벤트 처리
    document.getElementById('search-bar').addEventListener('input', function() {
        var query = this.value.toLowerCase(); // 입력값을 소문자로 변환하여 검색
        showSuggestions(query);
    });

    function showSuggestions(query) {
        var suggestionBox = document.getElementById('suggestions');
        suggestionBox.innerHTML = ''; // 기존 목록 초기화
        if (query.length === 0) {
            suggestionBox.style.display = 'none';
            return;
        }

        // 검색어와 일치하는 최대 5개의 노드 찾기
        var matches = nodes.get().filter(n => n.searchkeyword.includes(query)).slice(0, 5);

        if (matches.length > 0) {
            suggestionBox.style.display = 'block';
            matches.forEach(node => {
                var li = document.createElement('li');
                li.textContent = node.label;
                li.style.padding = '10px';
                li.style.cursor = 'pointer';
                li.onclick = function() {
                    focusNode(node.id); // 클릭 시 해당 노드로 포커스
                    suggestionBox.style.display = 'none'; // 목록 숨김
                    document.getElementById('search-bar').value = node.label; // 검색창에 선택한 노드명 표시
                };
                suggestionBox.appendChild(li);
            });
        } else {
            suggestionBox.style.display = 'none';
        }
    }

    function focusNode(nodeId) {
        // 노드 선택 시 확대 및 사이드 패널 열기
        var node = nodes.get(nodeId);
        showSidePanel(node);  // 검색으로 노드를 선택했을 때도 사이드바 열기

        network.focus(nodeId, {
            scale: 2.0,
            animation: {
                duration: 1000,
                easingFunction: "easeInOutQuad"
            }
        });
    }

    
</script>
</body>
</html>
